{
  "version": 3,
  "sources": ["../../server/team-validator-async.ts"],
  "sourcesContent": ["/**\n * Team Validator\n * Pokemon Showdown - http://pokemonshowdown.com/\n *\n * Spawns a child process to validate teams.\n *\n * @license MIT\n */\n\nimport { TeamValidator } from '../sim/team-validator';\nimport * as ConfigLoader from './config-loader';\n\nexport const PM = new QueryProcessManager<{\n\tformatid: string, options?: { removeNicknames?: boolean }, team: string,\n}>('team-validator', module, message => {\n\tconst { formatid, options, team } = message;\n\tconst parsedTeam = Teams.unpack(team);\n\n\tif (Config.debugvalidatorprocesses && process.send) {\n\t\tprocess.send('DEBUG\\n' + JSON.stringify(message));\n\t}\n\n\tlet problems;\n\ttry {\n\t\tproblems = TeamValidator.get(formatid).validateTeam(parsedTeam, options);\n\t} catch (err) {\n\t\tMonitor.crashlog(err, 'A team validation', {\n\t\t\tformatid,\n\t\t\tteam,\n\t\t});\n\t\tproblems = [\n\t\t\t`Your team crashed the validator. We'll fix this crash within a few hours (we're automatically notified),` +\n\t\t\t` but if you don't want to wait, just use a different team for now.`,\n\t\t];\n\t}\n\n\tif (problems?.length) {\n\t\treturn '0' + problems.join('\\n');\n\t}\n\tconst packedTeam = Teams.pack(parsedTeam);\n\t// console.log('FROM: ' + message.substr(pipeIndex2 + 1));\n\t// console.log('TO: ' + packedTeam);\n\treturn '1' + packedTeam;\n}, 2 * 60 * 1000);\n\nexport class TeamValidatorAsync {\n\tstatic PM = PM;\n\n\tformat: Format;\n\n\tconstructor(format: string) {\n\t\tthis.format = Dex.formats.get(format);\n\t}\n\n\tvalidateTeam(team: string, options?: { removeNicknames?: boolean, user?: ID }) {\n\t\tlet formatid = this.format.id;\n\t\tif (this.format.customRules) formatid += '@@@' + this.format.customRules.join(',');\n\t\tif (team.length > (25 * 1024 - 6)) { // don't even let it go to the child process\n\t\t\treturn Promise.resolve('0Your team is over 25KB. Please use a smaller team.');\n\t\t}\n\t\treturn PM.query({ formatid, options, team });\n\t}\n\n\tstatic get(this: void, format: string) {\n\t\treturn new TeamValidatorAsync(format);\n\t}\n\n\tstatic start(processCount: ConfigLoader.SubProcessesConfig) {\n\t\tstart(processCount);\n\t}\n}\n\nexport const get = TeamValidatorAsync.get;\n\n/*********************************************************\n * Process manager\n *********************************************************/\n\nimport { QueryProcessManager } from '../lib/process-manager';\n\nif (!PM.isParentProcess) {\n\tConfigLoader.ensureLoaded();\n\tglobal.Monitor = {\n\t\tcrashlog(error: Error, source = 'A team validator process', details: AnyObject | null = null) {\n\t\t\tconst repr = JSON.stringify([error.name, error.message, source, details]);\n\t\t\tprocess.send!(`THROW\\n@!!@${repr}\\n${error.stack}`);\n\t\t},\n\t};\n\n\tif (Config.crashguard) {\n\t\tprocess.on('uncaughtException', (err: Error) => {\n\t\t\tMonitor.crashlog(err, `A team validator process`);\n\t\t});\n\t\tprocess.on('unhandledRejection', err => {\n\t\t\tMonitor.crashlog(err as any || {}, 'A team validator process Promise');\n\t\t});\n\t}\n\n\tglobal.Dex = require('../sim/dex').Dex.includeData();\n\tglobal.Teams = require('../sim/teams').Teams;\n\n\t// eslint-disable-next-line no-eval\n\tPM.startRepl((cmd: string) => eval(cmd));\n}\n\nexport function start(processCount: ConfigLoader.SubProcessesConfig) {\n\tPM.spawn(processCount['validator'] ?? 1);\n}\n\nexport function destroy() {\n\t// No need to destroy the PM under normal circumstances, since\n\t// hotpatching uses PM.respawn()\n\tvoid PM.destroy();\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AASA,4BAA8B;AAC9B,mBAA8B;AAoE9B,6BAAoC;AA9EpC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAYO,MAAM,KAAK,IAAI,2CAEnB,kBAAkB,QAAQ,aAAW;AACvC,QAAM,EAAE,UAAU,SAAS,KAAK,IAAI;AACpC,QAAM,aAAa,MAAM,OAAO,IAAI;AAEpC,MAAI,OAAO,2BAA2B,QAAQ,MAAM;AACnD,YAAQ,KAAK,YAAY,KAAK,UAAU,OAAO,CAAC;AAAA,EACjD;AAEA,MAAI;AACJ,MAAI;AACH,eAAW,oCAAc,IAAI,QAAQ,EAAE,aAAa,YAAY,OAAO;AAAA,EACxE,SAAS,KAAK;AACb,YAAQ,SAAS,KAAK,qBAAqB;AAAA,MAC1C;AAAA,MACA;AAAA,IACD,CAAC;AACD,eAAW;AAAA,MACV;AAAA,IAED;AAAA,EACD;AAEA,MAAI,UAAU,QAAQ;AACrB,WAAO,MAAM,SAAS,KAAK,IAAI;AAAA,EAChC;AACA,QAAM,aAAa,MAAM,KAAK,UAAU;AAGxC,SAAO,MAAM;AACd,GAAG,IAAI,KAAK,GAAI;AAET,MAAM,mBAAmB;AAAA,EAC/B;AAAA,SAAO,KAAK;AAAA;AAAA,EAIZ,YAAY,QAAgB;AAC3B,SAAK,SAAS,IAAI,QAAQ,IAAI,MAAM;AAAA,EACrC;AAAA,EAEA,aAAa,MAAc,SAAoD;AAC9E,QAAI,WAAW,KAAK,OAAO;AAC3B,QAAI,KAAK,OAAO,YAAa,aAAY,QAAQ,KAAK,OAAO,YAAY,KAAK,GAAG;AACjF,QAAI,KAAK,SAAU,KAAK,OAAO,GAAI;AAClC,aAAO,QAAQ,QAAQ,qDAAqD;AAAA,IAC7E;AACA,WAAO,GAAG,MAAM,EAAE,UAAU,SAAS,KAAK,CAAC;AAAA,EAC5C;AAAA,EAEA,OAAO,IAAgB,QAAgB;AACtC,WAAO,IAAI,mBAAmB,MAAM;AAAA,EACrC;AAAA,EAEA,OAAO,MAAM,cAA+C;AAC3D,UAAM,YAAY;AAAA,EACnB;AACD;AAEO,MAAM,MAAM,mBAAmB;AAQtC,IAAI,CAAC,GAAG,iBAAiB;AACxB,eAAa,aAAa;AAC1B,SAAO,UAAU;AAAA,IAChB,SAAS,OAAc,SAAS,4BAA4B,UAA4B,MAAM;AAC7F,YAAM,OAAO,KAAK,UAAU,CAAC,MAAM,MAAM,MAAM,SAAS,QAAQ,OAAO,CAAC;AACxE,cAAQ,KAAM;AAAA,MAAc,IAAI;AAAA,EAAK,MAAM,KAAK,EAAE;AAAA,IACnD;AAAA,EACD;AAEA,MAAI,OAAO,YAAY;AACtB,YAAQ,GAAG,qBAAqB,CAAC,QAAe;AAC/C,cAAQ,SAAS,KAAK,0BAA0B;AAAA,IACjD,CAAC;AACD,YAAQ,GAAG,sBAAsB,SAAO;AACvC,cAAQ,SAAS,OAAc,CAAC,GAAG,kCAAkC;AAAA,IACtE,CAAC;AAAA,EACF;AAEA,SAAO,MAAM,QAAQ,YAAY,EAAE,IAAI,YAAY;AACnD,SAAO,QAAQ,QAAQ,cAAc,EAAE;AAGvC,KAAG,UAAU,CAAC,QAAgB,KAAK,GAAG,CAAC;AACxC;AAEO,SAAS,MAAM,cAA+C;AACpE,KAAG,MAAM,aAAa,WAAW,KAAK,CAAC;AACxC;AAEO,SAAS,UAAU;AAGzB,OAAK,GAAG,QAAQ;AACjB;",
  "names": []
}
